#!/bin/bash

# Starting with just bash, posix and curl, bootstrap our infrastructure.
# When done, the filesystem will look like this:
#
# TARGET_DIR
# ├── conda_package_cache  (contents hidden for brevity)
# ├── engine_home
# │   ├── engine -> engine_a
# │   ├── engine_a
# │   │   ├── bin
# │   │   ├── conda-meta
# │   │   ├── condabin
# │   │   ├── etc
# │   │   ├── include
# │   │   ├── lib
# │   │   ├── libexec
# │   │   ├── man
# │   │   ├── sbin
# │   │   ├── share
# │   │   ├── shell
# │   │   └── ssl
# │   └── micromamba
# └── infrastructure
#     ├── blue
#     ├── green
#     ├── production -> green
#     └── staging -> blue
#
# The contents of the active engine are defined by resources/defs/special/engine.yaml

set -euo pipefail

# Default values
OFFLINE=""
FORCE=""
VERBOSE=""
YES=""
DRY_RUN=""
TARGET_DIR=""

main() {
    parse_args "$@"

    log_info "Starting bootstrap infrastructure"
    log_debug "Arguments: TARGET_DIR=$TARGET_DIR, OFFLINE=$OFFLINE, VERBOSE=$VERBOSE, YES=$YES, DRY_RUN=$DRY_RUN"

    determine_locations

    if [[ -n "$DRY_RUN" ]]; then
        log_info "[DRY RUN] Would run: $SCRIPT_DIR/bootstrap-engine $TARGET_DIR $OFFLINE $VERBOSE -y --dry-run"
    else
        "$SCRIPT_DIR"/bootstrap-engine "$TARGET_DIR" $OFFLINE $VERBOSE -y
    fi

    setup_target
}

parse_args() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            --offline)
                OFFLINE="--offline"
                shift
                ;;
            --force)
                FORCE=y
                shift
                ;;
            -v|--verbose)
                VERBOSE="--verbose"
                shift
                ;;
            -n|--dry-run)
                DRY_RUN="y"
                shift
                ;;
            -h|--help)
                usage
                exit 0
                ;;
            -*)
                die "Unknown option: $1"
                ;;
            *)
                if [[ -n "$TARGET_DIR" ]]; then
                    die "Too many arguments"
                fi
                TARGET_DIR="$1"
                shift
                ;;
        esac
    done

    if [[ -z "$TARGET_DIR" ]]; then
        die "TARGET_DIR argument is required"
    fi
}

determine_locations() {
    # Get the directory containing this script, then go up one level
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    log_debug "SCRIPT_DIR=$SCRIPT_DIR"
}

setup_target() {
    if [[ -n "$DRY_RUN" ]]; then
        log_info "[DRY RUN] Would change to directory: $TARGET_DIR"
    else
        cd "$TARGET_DIR"
    fi

    if [[ -e "$TARGET_DIR/infrastructure" ]]; then
        if [[ -z $FORCE ]]; then
            die "$TARGET_DIR/infrastructure already exists"
        else
            log_info "Erasing $TARGET_DIR/infrastructure"
            if [[ -n "$DRY_RUN" ]]; then
                log_info "[DRY RUN] Would remove: $TARGET_DIR/infrastructure"
            else
                rm -rf "$TARGET_DIR/infrastructure"
            fi
        fi
    fi

    if [[ -n "$DRY_RUN" ]]; then
        log_info "[DRY RUN] Would create directories: conda_package_cache engine_home infrastructure"
        log_info "[DRY RUN] Would create directories: infrastructure/blue infrastructure/green"
        log_info "[DRY RUN] Would create symlinks: staging -> blue, production -> green"
    else
        mkdir -p conda_package_cache engine_home infrastructure
        cd infrastructure
        mkdir -p blue green
        if [[ ! -e staging ]]; then
            ln -s blue staging
            ln -s green production
        fi
    fi
}

usage() {
    cat << EOF
Usage: $(basename "${BASH_SOURCE[0]}") [-h] [-v] [--force] [--dry-run] TARGET_DIR

Create TARGET_DIR if it does not already exist, and populated it with  a
subdirectory named "conda_package_cache" and another subdirectory named
"infrastructure". It is an error if "infrastructure" already exists unless
the --force option is applied.

Following the creation of the infrastructure directory, this script will create
engine_home if it does not already exist and then install or update the engine.

Available options:

-h, --help          Print this help and exit.
-v, --verbose       Print script debug info.
-n, --dry-run       Show what would be done without making changes.
--no-color          Turn off color output.
--offline           No internet usage
--force             Erase existing tier in current infrastructure!

Exit codes:
  0   Success
  1   General error (usage error, missing TARGET_DIR, already exists without --force)
  2   Missing dependency (failed to setup micromamba or other required tool)
  3   Invalid input (invalid path, permissions error)
  4   Operation failed (command execution failure)

EOF
    exit
}

die() {
    log_error "$1"
    exit "${2:-1}"
}

log_info() {
    echo "INFO: $*" >&2
}

log_debug() {
    if [[ -n "$VERBOSE" ]]; then
        echo "DEBUG: $*" >&2
    fi
}

log_error() {
    echo "ERROR: $*" >&2
}

main "$@"
